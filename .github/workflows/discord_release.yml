name: Notify Discord on Release

on:
  release:
    types: [released, published]
  workflow_dispatch:

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Get Latest Release info
        if: github.event_name == 'workflow_dispatch'
        id: latest_release
        run: |
          # Fetch the latest release (including pre-releases)
          # Change to /releases/latest if you only want full production releases
          RELEASE_DATA=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/${{ github.repository }}/releases" | jq '.[0]')
          
          echo "name=$(echo $RELEASE_DATA | jq -r .name)" >> $GITHUB_OUTPUT
          echo "tag=$(echo $RELEASE_DATA | jq -r .tag_name)" >> $GITHUB_OUTPUT
          echo "url=$(echo $RELEASE_DATA | jq -r .html_url)" >> $GITHUB_OUTPUT
          echo "date=$(echo $RELEASE_DATA | jq -r .published_at)" >> $GITHUB_OUTPUT
          
          # Handle the body separately to avoid multiline string issues in GITHUB_OUTPUT
          echo $RELEASE_DATA | jq -r .body > release_body.txt

      - name: Send Rich Message to Discord
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        run: |
          # Determine values based on trigger type
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            REL_NAME="${{ steps.latest_release.outputs.name }}"
            REL_URL="${{ steps.latest_release.outputs.url }}"
            REL_DATE="${{ steps.latest_release.outputs.date }}"
            MESSAGE_BODY=$(cat release_body.txt)
          else
            REL_NAME="${{ github.event.release.name }}"
            REL_URL="${{ github.event.release.html_url }}"
            REL_DATE="${{ github.event.release.published_at }}"
            MESSAGE_BODY=$(cat <<EOF
          ${{ github.event.release.body }}
          EOF
          )
          fi

          # Prepare body text for JSON
          CLEAN_BODY=$(echo "$MESSAGE_BODY" | jq -aRs .)

          curl -H "Content-Type: application/json" \
          -d "{
            \"content\": \"**$REL_NAME**\",
            \"embeds\": [{
              \"title\": \"Changelog\",
              \"url\": \"$REL_URL\",
              \"description\": $CLEAN_BODY,
              \"color\": 2058496,
              \"footer\": { \"text\": \"Release Date: $REL_DATE\" }
            }]
          }" \
          "$DISCORD_WEBHOOK"
